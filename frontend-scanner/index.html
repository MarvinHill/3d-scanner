<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Document</title>
</head>
<body class="bg-gray-700">
    
    <div class="relative flex flex-col justify-center items-center w-full min-h-screen">
        <div class="flex justify-center pb-4">
            <h1 class="text-3xl font-bold my-4 text-gray-100">Scanner Controller</h1>
        </div>
        <div class="flex flex-col items-center">
            <div class="flex flex-col sm:flex-row gap-2">
                <div class="flex flex-col justify-center items-center mt-4 bg-gray-600 min-w-44 rounded-xl p-4">
                    <h2 class="font-bold text-xl mb-3 text-cente text-gray-200 h-16">Camera Axis</h2>
                    <button id="cameraPlus" class="select-none m-2 size-12 bg-slate-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded">+</button>
                    <button id="cameraMinus" class="select-none m-2 size-12 bg-slate-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded">-</button>
                </div>
                <div class="flex flex-col justify-center items-center mt-4 bg-gray-600 min-w-44 rounded-xl p-4">
                    <h2 class="font-bold text-xl mb-3 text-cente text-gray-200 h-16">Table Axis</h2>
                    <button id="tablePlus" class="select-none m-2 size-12 bg-slate-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded">+</button>
                    <button id="tableMinus" class="select-none m-2 size-12 bg-slate-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded">-</button>
                </div>
            </div>
            <button id="levelScanner" class="select-none mt-4 h-12 bg-blue-700 hover:bg-blue-600 text-gray-200 font-bold py-2 px-4 rounded">Level Scanner</button>
            <button id="setScannerLevel" class="select-none mt-4 h-12 bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded">Set Level</button>
            <button class="select-none opacity-15 my-4 h-12 bg-green-700 hover:bg-green-600 text-gray-200 font-bold py-2 px-4 rounded">Start Scanning</button>
            
            <div class="flex flex-col justify-center items-center mt-4 bg-gray-600 min-w-44 rounded-xl p-4">
              <label class="font-bold text-xl mb-3 text-cente text-gray-200 h-6" for="cameraAxisCount">Kamera Angle Count</label>
              <input id="cameraAxisCount" class="appearance-none bg-transparent cursor-pointer w-40 my-3" type="range" name="cameraAxisCount" min="2" max="45">
              <p class="font-bold text-xl mb-3 text-cente text-gray-200 h-6">Amount: <output id="cameraCountOutput">24</output></p>

              <label class="font-bold text-xl mb-3 text-cente text-gray-200 h-6" for="tableAxisCount">Table Angle Count</label>
              <input id="tableAxisCount" class="appearance-none bg-transparent cursor-pointer w-40 my-3" type="range" name="tableAxisCount" min="2" max="90">
              <p class="font-bold text-xl mb-3 text-cente text-gray-200 h-6">Amount: <output id="tableCountOutput">46</output></p>
            </div>

            <button id="startProgram" class="my-4 h-12 bg-green-700 hover:bg-green-600 text-gray-200 font-bold py-2 px-4 rounded">Start Program</button>
        </div>
    </div>
</body>
<script>

    let interval = null;
    const basePath = "https://scanner.local/scanner";


    function clearInter() {
        if(interval){
            clearInterval(interval);
            interval = null;
        }
    }

    function cameraAxisPlus() {
        interval = setInterval(async () => {
            await fetch(`${basePath}/cameraAxisPlus`)
            console.log("camera axis plus")
        }, 500);
    }
    
    function cameraAxisMinus() {
        interval = setInterval(async () => {
            await fetch(`${basePath}/cameraAxisMinus`)
            console.log("camera axis minus")
        }, 500);
    }

    function tableAxisPlus() {
        interval = setInterval(async () => {
            await fetch(`${basePath}/tableAxisPlus`)
            console.log("table axis plus")
        }, 500);
    }

    function tableAxisMinus() {
        interval = setInterval(async () => {
            await fetch(`${basePath}/tableAxisMinus`)
            console.log("table axis minus")
        }, 500);
    }

    async function levelScanner() {
        await fetch(`${basePath}/levelScanner`)
        console.log("level scanner")
    }
    
    async function setScannerLevel() {
        await fetch(`${basePath}/setScannerLevel`)
        console.log("set scanner level")
    }

    async function takePhoto(angleCameraAxis, angleTableAxis) {
        let response = await fetch(`${basePath}/takePhoto`, {
        method: "POST",
        body: JSON.stringify({
            angleCameraAxis: angleCameraAxis,
            angleTableAxis: angleTableAxis
        }),
        })
        response = await response.json()
        addImage(response.photoData)
        console.log(angleCameraAxis, angleTableAxis)
    }

    function addImage(data){
        let img = document.createElement("img")
        img.src = `data:image/png;base64,${data}`
        img.style.width = "500px"
        img.style.height = "500px"
        img.addEventListener("click", () => downloadImage(img.src))
        document.body.appendChild(img)
      }
      
    function downloadImage(url) {
      const a = document.createElement('a')
      a.href = url
      a.download = url.split('/').pop()
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
    }

    async function runProgram() {
      cameraAxisCount = document.querySelector("#cameraAxisCount").value
      tableAxisCount = document.querySelector("#tableAxisCount").value
      cameraDeltaDegrees = 90 / (cameraAxisCount - 1)
      tableDeltaDegrees = 360 / (tableAxisCount - 1)
      
      // await levelScanner()

      for (let i = 0; i < cameraAxisCount; i++) {
        for (let j = 0; j < tableAxisCount; j++) {
          await takePhoto(Math.floor(cameraDeltaDegrees * i), Math.floor(tableDeltaDegrees * j))
        }
      }
    }

    function onCameraCountChange(event) {
      cameraCountOutput = document.querySelector("#cameraCountOutput")
      cameraCountOutput.value = event.target.value
    }
    function onTableCountChange(event) {
      tableCountOutput = document.querySelector("#tableCountOutput")
      tableCountOutput.value = event.target.value
    }

    document.querySelector("#cameraPlus").addEventListener("mousedown", cameraAxisPlus)
    document.querySelector("#cameraPlus").addEventListener("mouseup", clearInter)
    document.querySelector("#cameraPlus").addEventListener("touchdown", cameraAxisPlus)
    document.querySelector("#cameraPlus").addEventListener("touchup", clearInter)

    document.querySelector("#cameraMinus").addEventListener("mousedown", cameraAxisMinus)
    document.querySelector("#cameraMinus").addEventListener("mouseup", clearInter)
    document.querySelector("#cameraMinus").addEventListener("touchdown", cameraAxisMinus)
    document.querySelector("#cameraMinus").addEventListener("touchup", clearInter)

    document.querySelector("#tablePlus").addEventListener("mousedown", tableAxisPlus)
    document.querySelector("#tablePlus").addEventListener("mouseup", clearInter)
    document.querySelector("#tablePlus").addEventListener("touchdown", tableAxisPlus)
    document.querySelector("#tablePlus").addEventListener("touchup", clearInter)

    document.querySelector("#tableMinus").addEventListener("mousedown", tableAxisMinus)
    document.querySelector("#tableMinus").addEventListener("mouseup", clearInter)
    document.querySelector("#tableMinus").addEventListener("touchdown", tableAxisMinus)
    document.querySelector("#tableMinus").addEventListener("touchup", clearInter)

    document.querySelector("#levelScanner").addEventListener("click", levelScanner)
    document.querySelector("#setScannerLevel").addEventListener("click", setScannerLevel)

    document.querySelector("#cameraAxisCount").addEventListener("input", onCameraCountChange)
    document.querySelector("#tableAxisCount").addEventListener("input", onTableCountChange)

    document.querySelector("#startProgram").addEventListener("click", runProgram)
</script>
</html>